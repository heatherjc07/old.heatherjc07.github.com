
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="author" content="Heather Campbell" />
    <meta name="description" content="Creating a customer annotation in Java">

    <title>Creating a Custom Annotation</title>

    <link rel="stylesheet" href="/assets/themes/dinky/css/styles.css">
    <link rel="stylesheet" href="/assets/themes/dinky/css/pygment_trac.css">
    <script src="/assets/themes/dinky/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header"><a href="/">Technical Musings of a Mummy</a></h1>
        <ul>
          
          
          


  
    
      
      	
      	<li><a class="button" href="/archive.html" >Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a class="button" href="/categories.html" >Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a class="button" href="/pages/about/index.html" >Me</a></li>
      	
      
    
  
    
      
      	
      	<li><a class="button" href="/pages.html" >Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a class="button" href="/tags.html" >Tags</a></li>
      	
      
    
  



        </ul>
        
        
        <div class="misc vcard">
          <h5 class="connect">Connect with Me</h5>
            

            <a href="mailto:heatherjcampbell@hotmail.co.uk"><img src="/assets/themes/dinky/images/email.png" alt="email"/></a>
            
            
            <a href="http://github.com/heatherjc07/" rel="me"><img src="/assets/themes/dinky/images/github.png" alt="github"/></a>
            
            
            <a href="http://twitter.com/HCampbell07/" rel="me"><img src="/assets/themes/dinky/images/twitter.png" alt="twitter"/></a>
            
            
            
            
            
        </div><!-- misc -->
        
      </header>

      <section>
      
<section>
  <h1>Creating a Custom Annotation</h1>

  <p>JSR 303 provides a set of built-in validations but there will be times when you need to create your own validation annotation. Thankfully the specification was written with that in mind and it is relatively simple to write a custom validation annotation.</p>

<p>A typical scenario could be that we want to validate that two passwords entered by the user match.</p>

<h2 id='defining_the_annotation'>Defining the Annotation</h2>
<script src='https://gist.github.com/5224957.js?file=Matches.java'> </script><noscript>
  <pre class='gist-no-script'><code># Matches.java

import static java.lang.annotation.ElementType.*;
import static java.lang.annotation.RetentionPolicy.*;
import java.lang.annotation.Documented;
import java.lang.annotation.Retention;
import java.lang.annotation.Target;
import javax.validation.Constraint;
import javax.validation.Payload;

@Target({TYPE, ANNOTATION_TYPE})
@Retention(RUNTIME)
@Constraint(validatedBy = MatchesValidator.class)
@Documented
public @interface Matches {

  String message() default &quot;{constraints.matches}&quot;; 
  Class[] groups() default {}; 
  Class[] payload() default {}; 
  String field(); 
  String verifyField();

}</code></pre>
</noscript>
<p>We use the @interface keyword to define an annotation.</p>

<p>There are certain attributes and annotations we must define in order to satisfy the specification.</p>

<ul>
<li>an attribute &#8220;message&#8221; that returns the default key for creating error messages in case the constraint is violated</li>

<li>an attribute &#8220;groups&#8221; that allows the specification of validation groups, to which this constraint belongs This must default to an empty array.</li>

<li><code>@Target({ METHOD, FIELD, ANNOTATION_TYPE })</code>: Says, that type declarations and annotation declarations may be annotated with @Matches (but not method or field declarations e.g.)</li>

<li><code>@Retention(RUNTIME)</code>: Specifies, that annotations of this type will be available at runtime by the means of reflection</li>

<li><code>@Constraint(validatedBy = MatchesValidator.class)</code>: Specifies the validator to be used to validate elements annotated with @Matches</li>

<li>Documented: Says, that the use of @Matches will be contained in the JavaDoc of elements annotated with it</li>
</ul>

<h2 id='implementing_the_constrainvalidator'>Implementing the ConstrainValidator</h2>

<p>The next step is to implement the ConstraintValidator that will validate classes with the <code>@Matches</code> annotation</p>
<script src='https://gist.github.com/5224957.js?file=MatchesValidator.java'> </script><noscript>
  <pre class='gist-no-script'><code># MatchesValidator.java

import org.mvel2.MVEL;
import javax.validation.ConstraintValidator; 
import javax.validation.ConstraintValidatorContext; 

public class MatchesValidator implements ConstraintValidator { 

  private String field;
  private String verifyField; 

  public void initialize(Matches constraintAnnotation) { 
    this.field = constraintAnnotation.field(); 
    this.verifyField = constraintAnnotation.verifyField(); 
  } 
  
  public boolean isValid(Object value, ConstraintValidatorContext context) { 
    Object fieldObj = MVEL.getProperty(field, value); 
    Object verifyFieldObj = MVEL.getProperty(verifyField, value); 
    boolean neitherSet = (fieldObj == null)&amp;amp;&amp;amp; (verifyFieldObj == null); 

    if (neitherSet) { 
      return true; 
    } 

    boolean matches = (fieldObj != null)&amp;amp;&amp;amp; fieldObj.equals(verifyFieldObj); 

    if (!matches) { 
      context.disableDefaultConstraintViolation(); 
      context.buildConstraintViolationWithTemplate(&quot;message&quot;).addNode(verifyField) 
        .addConstraintViolation(); 
    } 

    return matches; 
  } 
}</code></pre>
</noscript>
<p>The ConstraintValidator interface specifies two type parameters, which we set in our implementation. The first specifies the annotation type to be validated by a ConstraintValidator (in our example Matches), the second the type of elements, which the validator can handle (we&#8217;re expecting an object). Specifying object means we don&#8217;t limit the validation annotation to a particular type. MVEL is used to inspect the properties of the object being validated. If we specified a particular type we could use the fields accessor methods. The implementation of the validator is straightforward. The initialize() method gives us access to any attributes of the annotation. In this case we&#8217;re expecting the name of the password field (field) and the match password field. (verifyfield)</p>

<p>The isValid() method determines whether the two fields match. If they do the @Matches annotation is satisfied. If they are not an exception is raised using the default message.</p>

<p>Note, that the specification recommends, that null values should be declared to be valid. If null is not a valid value for an element, it should be annotated with @NotNull explicitly.</p>

<h2 id='specifying_the_error_message'>Specifying the Error Message</h2>

<p>Next we need to specify the error message. To do so, we create a file named ValidationMessages.properties under src/main/resources with the following content:</p>
<script src='https://gist.github.com/5224957.js?file=ValidationMessages.properties'> </script><noscript>
  <pre class='gist-no-script'><code># ValidationMessages.properties

constraints.matches=Your confirmation password does not match the password you entered. </code></pre>
</noscript>
<h2 id='using_our_new_annotation'>Using Our New Annotation</h2>

<p>We can now use the @Matches annotation on our CreateUserAccountForm class to verify the password and passwordRepeat fields match.</p>
<script src='https://gist.github.com/5224957.js?file=CreateUserAccountForm.java'> </script><noscript>
  <pre class='gist-no-script'><code># CreateUserAccountForm.java

@Matches(field=&quot;password&quot;, verifyField=&quot;passwordRepeat&quot;) 
public class CreateUserAccountForm { 

  @Size(min=6, max=20) 
  private String password;

  @Size(min=6, max=20) 
  private String passwordRepeat; 
  ... 
}</code></pre>
</noscript>
<h2 id='testing_the_new_constraint'>Testing the New Constraint</h2>

<p>We can then write a simple junit test to check our new constraint</p>
<script src='https://gist.github.com/5224957.js?file=MatchesTest.java'> </script><noscript>
  <pre class='gist-no-script'><code># MatchesTest.java

import static org.junit.Assert.*;
import java.util.Set;
import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import javax.validation.ValidatorFactory;
import org.junit.BeforeClass;
import org.junit.Test;

public class MatchesTest {
 
  private static Validator validator;  
 
  @BeforeClass
  public static void setUp() {
    ValidatorFactory factory 
      = Validation.buildDefaultValidatorFactory();
    validator = factory.getValidator();
  }

  @Test
  public void testPasswordsNotMatching () {
    CreateUserAccountForm form 
      = new CreateUserAccountForm (&quot;Password1&quot;, &quot;PasswordBlah&quot;);
      
    Set&gt; constraintViolations =

    validator.validate(form);

    assertEquals(1, constraintViolations.size());
    assertEquals(
     &quot;Your confirmation password does not match the password you entered.&quot;, 
      constraintViolations.iterator().next()
      .getInterpolatedMessage());
  }
  
  @Test
  public void testPasswordsValid() {
    CreateUserAccountForm form 
      = new CreateUserAccountForm(&quot;Password1&quot;, &quot;Password1&quot;);

    Set&gt; constraintViolations = 
      validator.validate(form);
    assertEquals(0, constraintViolations.size());
  }
}</code></pre>
</noscript>
  If you enjoyed this post, please
<a href="https://twitter.com/intent/tweet?url=http://heatherjcampbell.com/tutorial/2012/06/14/creating-a-custom-annotation&text=Creating a Custom Annotation &via=hcampbell07" 
   target="_blank">
  share it</a> 
or 
<a href="https://twitter.com/hcampbell07">
  follow me on Twitter</a>
<div id="page-navigation">
        <div class="clear">&nbsp;</div>
        <div class="left">
        
                <a href="/books/2012/06/13/passionate-programmer" title="Previous Post:
Passionate Programmer">&laquo; Passionate Programmer</a>
        
        </div>

        <div class="right">
        
                <a href="/skills/2012/06/14/the-process-of-selecting-a-product" title="next Post:
The Process of Selecting a Product">The Process of Selecting a Product &raquo; </a>
        
        </div>
        <div class="clear">&nbsp;</div>
</div> 
  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'technicalmusingsofamummy'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</section>


      </section>

      <footer>
      <p><small>Hosted on <a href="http://pages.github.com/">GitHub Pages</a> using the <a href="https://github.com/sodabrew/theme-dinky">Dinky theme</a> for <a href="http://jekyllbootstrap.com/">Jekyll Bootstrap</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>

