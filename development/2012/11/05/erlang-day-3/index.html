
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="author" content="Heather Campbell" />
    <meta name="description" content="Erlang Day 3: Seven Languages in Seven Weeks">

    <title>Erlang Day 3</title>

    <link rel="stylesheet" href="/assets/themes/dinky/css/styles.css">
    <link rel="stylesheet" href="/assets/themes/dinky/css/pygment_trac.css">
    <script src="/assets/themes/dinky/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header"><a href="/">Technical Musings of a Mummy</a></h1>
        <ul>
          
          
          


  
    
      
      	
      	<li><a class="button" href="/archive.html" >Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a class="button" href="/categories.html" >Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a class="button" href="/pages/about/index.html" >Me</a></li>
      	
      
    
  
    
      
      	
      	<li><a class="button" href="/pages.html" >Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a class="button" href="/tags.html" >Tags</a></li>
      	
      
    
  



        </ul>
        
        
        <div class="misc vcard">
          <h5 class="connect">Connect with Me</h5>
            

            <a href="mailto:heatherjcampbell@hotmail.co.uk"><img src="/assets/themes/dinky/images/email.png" alt="email"/></a>
            
            
            <a href="http://github.com/heatherjc07/" rel="me"><img src="/assets/themes/dinky/images/github.png" alt="github"/></a>
            
            
            <a href="http://twitter.com/HCampbell07/" rel="me"><img src="/assets/themes/dinky/images/twitter.png" alt="twitter"/></a>
            
            
            
            
            
        </div><!-- misc -->
        
      </header>

      <section>
      
<section>
  <h1>Erlang Day 3</h1>

  <p><em>My experience with day three of exploring Erlang through <a href='http://pragprog.com/book/btlang/seven-languages-in-seven-weeks' target='_blank'>Seven Languages in Seven Weeks</a>.</em></p>

<p>After a couple of days of having to reprogram how I approach problems coming from an OO background I&#8217;m looking forwards to tackling the areas that Erlang excels at, concurrency and reliability.</p>

<h2 id='concurrency'>Concurrency</h2>

<p>Concurrency in Erlang is build upon three basic primitives</p>

<ul>
<li><strong>! :</strong> to send a message</li>

<li><strong>spawn :</strong> to spawn a process</li>

<li><strong>receive:</strong> to receive a message</li>
</ul>

<p>Lets start with a basic example where we create a function which receives a message from another process and displays the appropriate information based on the format of the message which was passed.</p>
<script src='https://gist.github.com/5554054.js?file=buy.erl'> </script><noscript>
  <pre class='gist-no-script'><code># buy.erl

-module(buy).
-export([purchase/0]).
purchase() -&gt;
  receive
     finished -&gt;
            io:format(&quot;purchases finished~n&quot;, []);
     {purchase, Item, Quantity} -&amp;gt;
            io:format(&quot;purchase received: ~p ~p ~n&quot;, 
              [Quantity, Item]),
            purchase()
end.</code></pre>
</noscript>
<p>If it receives a message of a finished atom it displays that the purchases have been completed and terminates.</p>

<p>If it receives a purchase atom it display the item and quantity which have been purchased and waits for the next purchase message.</p>
<script src='https://gist.github.com/5554054.js?file=use_buy.erl'> </script><noscript>
  <pre class='gist-no-script'><code># use_buy.erl

c(buy).
Pid = spawn(fun buy:purchase/0).
Pid ! {purchase, &quot;pen&quot;, 3}.
% prints &quot;purchase received: 3 pen&quot;
Pid ! {purchase, &quot;desk&quot;, 1}.
% prints &quot;purchase received: 1 desk&quot;
Pid ! finished.
% prints &quot;purchases finished&quot;</code></pre>
</noscript>
<p>In the code above we compile our module and use spawn to start our purchase function in a lightweight process. spawn returns a process ID which we store in a variable. We can then use this variable to send messages to our process with ! syntax. This is an asynchronous example where a message is being sent and the system which sends the message is not waiting on a reply.</p>

<h2 id='synchronous_messaging'>Synchronous Messaging</h2>

<p>Lets modify our functions to support synchronous messaging. The helper method purchase sends a message to the function purchase including a reference to itself so purchase can send a message back indicating it has printed the purchase.</p>
<script src='https://gist.github.com/5554054.js?file=buy_sync.erl'> </script><noscript>
  <pre class='gist-no-script'><code># buy_sync.erl

-module(buy_sync).
-export([purchase/0, purchaser/3]).
purchase() -&gt;
  receive
     finished -&gt;
            io:format(&quot;purchases finished~n&quot;, []);
     {From,{purchase, Item, Quantity}} -&amp;gt;
            io:format(&quot;purchase received: 
              ~p ~p ~n&quot;, [Quantity, Item]),
     From! printed,
            purchase()
end.

purchaser(To, Item, Quantity) -&gt;
  To ! {self(), {purchase, Item, Quantity }},
  receive
     printed -&amp;gt;
           io:format(&quot;Purchase Printed~n&quot;, [])

end.

c(buy_sync).
PurchasePrinter = spawn(fun buy_sync:purchase/0).
buy_sync:purchaser(PurchasePrinter, &quot;pen&quot;, 3).
% prints &quot;purchase received: 3 pen&quot;
% prints &quot;Purchase Printed&quot;
buy_sync:purchaser(PurchasePrinter, &quot;desk&quot;, 1).
% prints &quot;purchase received: 1 desk&quot;
% prints &quot;Purchase Printed&quot;
PurchasePrinter ! finished.
% prints &quot;purchases finished&quot;</code></pre>
</noscript>
<h2 id='linking_processes_for_reliability'>Linking Processes for Reliability</h2>

<p>Below we have a simple function which represents russian roulette. It accepts a number between 1 and 6 and if that number is three the process kills iteself. Any other number prints &#8220;click&#8221; and waits for the next message.</p>
<script src='https://gist.github.com/5554054.js?file=roulette.erl'> </script><noscript>
  <pre class='gist-no-script'><code># roulette.erl

-module(roulette).
-export([loop/0]).
% send a number, 1-6
loop() -&gt;
receive
  3 -&gt; io:format(&quot;bang.~n&quot;), exit({roulette,die,at,erlang:time()});
  _ -&gt; io:format(&quot;click~n&quot;), loop()
end.

c(roulette).
Gun = spawn(fun roulette:loop/0).
Gun ! 1.
% prints &quot;click&quot;
Gun ! 3.
% prints &quot;bang&quot; and kills roulette process
Gun ! 4.
% does nothing as process is dead
Gun ! 1.
% does nothing as process is dead</code></pre>
</noscript>
<p>In the calling code above you can see that once the value 3 has been sent further calls to the roulette process do nothing as it is dead.</p>

<p>We can verify this using the following code.</p>

<pre><code>erlang:is_process_alive(Gun).
% returns false</code></pre>

<p>We can create our own function to monitor a process and declare when it is dead. process_flag sets a flag on the process which calls the function to convert exit signals to {&#8216;EXIT&#8217;, From, Reason} messages, which can be received as ordinary messages. We then define how to handle the messages we receive. For a normal message we link the coroner process to any process with a PID of Process and print out that we are monitoring the process. For exit messages we print out that the process has died and why.</p>
<script src='https://gist.github.com/5554054.js?file=coroner.erl'> </script><noscript>
  <pre class='gist-no-script'><code># coroner.erl

-module(coroner).
-export([loop/0]).
loop() -&gt;
  process_flag(trap_exit, true),
  receive
    {monitor, Process} -&gt;
      link(Process),
      io:format(&quot;Monitoring process.~n&quot;),
      loop();
    {'EXIT', From, Reason} -&gt;
      io:format(&quot;The shooter died 
          with reason ~p.&quot;, [Reason]),
      io:format(&quot;Start another one.~n&quot;),
      loop()
end.


c(roulette).
c(coroner).
Revolver=spawn(fun roulette:loop/0).
Coroner=spawn(fun coroner:loop/0).

Coroner ! {monitor, Revolver}.
% prints Monitoring process.

Revolver ! 1.
% prints &quot;click&quot;
Revolver ! 3.
% prints &quot;bang.&quot;
% prints &quot;The shooter died with reason
%{roulette,die,at,{8,48,1}}. Start another one.%</code></pre>
</noscript>
<p>We can improve on this further by creating a function that not only tells us when the process has died but then restarts it for us.When we receive a new message we spawn a roulette process and link it to our doctor process so the doctor process will get notified if it dies. We register the roulette processes id with the revolver atom. This allows us to send messages to the roulette process using revolver ! message without needing the PID. The exit handling has been enhanced to send a message to itself telling it to spawn a new game.</p>
<script src='https://gist.github.com/5554054.js?file=doctor.erl'> </script><noscript>
  <pre class='gist-no-script'><code># doctor.erl

-module(doctor).
-export([loop/0]).
loop() -&gt;
  process_flag(trap_exit, true),
  receive
    new -&gt;
      io:format(&quot;Creating and monitoring process.~n&quot;),
      register(revolver, spawn_link(fun roulette:loop/0)),
      loop();
    {'EXIT', From, Reason} -&gt;
      io:format(&quot;The shooter died with reason ~p.&quot;, [Reason]),
      io:format(&quot; Restarting. ~n&quot;),
      self() ! new,
      loop()
end. 

c(doctor).
Doc = spawn(fun doctor:loop/0).
Doc ! new.
% prints &quot;Creating and monitoring process.&quot;

revolver ! 1.
% prints &quot;click&quot;

revolver ! 3.
% prints &quot;bang.&quot;
% prints &quot;The shooter died with reason {roulette,die,at,{8,53,40}}.
Restarting.&quot;
% prints &quot;Creating and monitoring process.&quot;

revolver ! 4.
% prints &quot;click&quot;</code></pre>
</noscript>
<p>This is just a basic example to demonstrate how Erlang creates robust concurrent systems by providing libraries that make it easy to monitor processes, determine when they have crashed and restart them. As mentioned in previous blogs Erlang encourages you to &#8216;Let it crash&#8217; rather than putting in lots of error handling.</p>

<h2 id='self_study'>Self Study</h2>

<p>Open Telecom Platform (OTP) is a powerful package with much of what you’ll need to build a distributed, concurrent service.</p>

<h3 id='find'>Find:</h3>

<p><em>An OTP service that will restart a process if it dies</em></p>

<p>http://www.erlang.org/doc/design_principles/sup_princ.html</p>

<p>http://www.hccp.org/supervisors.html</p>

<p><em>Documentation for building a simple OTP server</em></p>

<p>http://learnyousomeerlang.com/what-is-otp</p>

<p>http://20bits.com/article/erlang-a-generic-server-tutorial</p>

<h3 id='do'>Do:</h3>

<ul>
<li>Monitor the translate_service and restart it should it die.</li>

<li>Make the Doctor process restart itself if it should die.</li>

<li>Make a monitor for the Doctor monitor. If either monitor dies, restart it.</li>
</ul>

<p>The following bonus questions will take a little bit of research to complete:</p>

<ul>
<li>Create a basic OTP server that logs messages to a file.</li>

<li>Make the translate_service work across a network.</li>
</ul>

<p>Check out my code at <a href='https://github.com/heatherjc07/seven_languages_in_seven_days/tree/master/Erlang/Day2' target='_blank'>github</a></p>
  If you enjoyed this post, please
<a href="https://twitter.com/intent/tweet?url=http://heatherjcampbell.com/development/2012/11/05/erlang-day-3&text=Erlang Day 3 &via=hcampbell07" 
   target="_blank">
  share it</a> 
or 
<a href="https://twitter.com/hcampbell07">
  follow me on Twitter</a>
<div id="page-navigation">
        <div class="clear">&nbsp;</div>
        <div class="left">
        
                <a href="/development/2012/11/01/erlang-day-2" title="Previous Post:
Erlang Day 2">&laquo; Erlang Day 2</a>
        
        </div>

        <div class="right">
        
                <a href="/development/2012/11/19/communication" title="next Post:
Communication">Communication &raquo; </a>
        
        </div>
        <div class="clear">&nbsp;</div>
</div> 
  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'technicalmusingsofamummy'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</section>


      </section>

      <footer>
      <p><small>Hosted on <a href="http://pages.github.com/">GitHub Pages</a> using the <a href="https://github.com/sodabrew/theme-dinky">Dinky theme</a> for <a href="http://jekyllbootstrap.com/">Jekyll Bootstrap</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>

